{% extends "base.html" %}

{% block title %}Panel de Administrador{% endblock %}

{% block content %}
<h1 class="mb-4 text-accent">// PANEL DE ADMINISTRACI√ìN</h1>

<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'tickets' %}active{% endif %}" 
           href="{{ url_for('panel_admin') }}">üìã GESTI√ìN DE INCIDENCIAS</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'usuarios' %}active{% endif %}" 
           href="{{ url_for('gestion_usuarios_admin') }}">üë§ GESTI√ìN DE USUARIOS</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'zonas' %}active{% endif %}" 
           href="{{ url_for('gestion_zonas_admin') }}">üìç GESTI√ìN DE ZONAS</a>
    </li>
</ul>

<div class="tab-content">
    
    {% if active_tab == 'tickets' %}
    <div class="row">
        <div class="col-lg-3">
            <div class="card shadow-sm mb-4 border-accent">
                <div class="card-header bg-charcoal text-accent">
                    RESUMEN DE ESTADOS
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Abierto
                        <span class="badge bg-danger">{{ status_counts['Abierto'] }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        En Progreso
                        <span class="badge bg-warning text-dark">{{ status_counts['En Progreso'] }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Resuelto
                        <span class="badge bg-success">{{ status_counts['Resuelto'] }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Rechazado
                        <span class="badge bg-secondary">{{ status_counts['Rechazado'] }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-accent text-charcoal fw-bold">
                        TOTAL
                        <span class="badge bg-charcoal text-accent">{{ all_tickets|length }}</span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-lg-9">
            <div class="card shadow-sm mb-4 border-accent">
                <div class="card-header bg-charcoal text-accent d-flex justify-content-between align-items-center">
                    LISTADO DE INCIDENCIAS
                    <form method="GET" action="{{ url_for('panel_admin') }}" class="d-flex" style="width: 200px;">
                        <input type="search" name="search_ref" class="form-control form-control-sm me-2" placeholder="Buscar Ref/T√≠tulo" value="{{ search_ref or '' }}">
                        <button class="btn btn-sm btn-outline-accent" type="submit">üîç</button>
                    </form>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h5 class="text-accent small mb-3">ABIERTOS</h5>
                            <div class="list-group kanban-column bg-charcoal p-2">
                                {% for ticket in status_groups['Abierto'] %}
                                    {% include '_kanban_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-accent small mb-3">EN PROGRESO</h5>
                            <div class="list-group kanban-column bg-charcoal p-2">
                                {% for ticket in status_groups['En Progreso'] %}
                                    {% include '_kanban_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-accent small mb-3">RESUELTOS</h5>
                            <div class="list-group kanban-column bg-charcoal p-2">
                                {% for ticket in status_groups['Resuelto'] %}
                                    {% include '_kanban_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-accent small mb-3">RECHAZADOS</h5>
                            <div class="list-group kanban-column bg-charcoal p-2">
                                {% for ticket in status_groups['Rechazado'] %}
                                    {% include '_kanban_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <hr>
    
    {% if active_tab == 'usuarios' %}
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm border-accent">
                <div class="card-header bg-accent text-charcoal">
                    <h5 class="mb-0">‚ûï CREAR NUEVO USUARIO</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('crear_usuario') }}">
                        <div class="mb-3">
                            <label for="nombre_completo" class="form-label small text-accent">NOMBRE COMPLETO</label>
                            <input type="text" class="form-control" id="nombre_completo" name="nombre_completo" required>
                        </div>
                        <div class="mb-3">
                            <label for="numero_acceso" class="form-label small text-accent">C√ìDIGO DE ACCESO (4 D√çGITOS)</label>
                            <input type="text" class="form-control" id="numero_acceso" name="numero_acceso" maxlength="4" required>
                        </div>
                        <button type="submit" class="btn btn-accent w-100">CREAR USUARIO</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <h5 class="text-accent small mb-3">LISTADO DE USUARIOS REGISTRADOS (ROL 'USER')</h5>
            {% if usuarios %}
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th class="text-accent">C√≥digo de Acceso</th>
                            <th class="text-accent">Nombre Completo</th>
                            <th class="text-accent">Rol</th>
                            <th class="text-accent">Tickets Creados</th>
                            <th class="text-accent">Acci√≥n</th> {# NUEVA COLUMNA #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in usuarios %}
                        <tr>
                            <td>{{ usuario.numero_acceso }}</td>
                            <td>{{ usuario.nombre_completo | upper }}</td>
                            <td>{{ usuario.rol | upper }}</td>
                            <td>{{ usuario.tickets|length }}</td>
                            <td> {# CONTENIDO DE ACCI√ìN (BOT√ìN ELIMINAR) #}
                                <form method="POST" 
                                      action="{{ url_for('eliminar_usuario') }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar al usuario {{ usuario.nombre_completo }}? Todos sus tickets y comentarios ser√°n eliminados.');">
                                    
                                    <input type="hidden" name="eliminar_usuario_id" value="{{ usuario.id }}">
                                    
                                    <button type="submit" class="btn btn-sm btn-danger">ELIMINAR</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="alert alert-info mt-3">NO HAY USUARIOS REGISTRADOS (ROL 'USER').</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <hr>
    
    {% if active_tab == 'zonas' %}
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm border-accent">
                <div class="card-header bg-accent text-charcoal">
                    <h5 class="mb-0">‚ûï CREAR NUEVA ZONA</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('gestionar_zonas') }}">
                        <div class="mb-3">
                            <label for="nombre_zona" class="form-label small text-accent">NOMBRE DE ZONA</label>
                            <input type="text" class="form-control" id="nombre_zona" name="nombre_zona" required>
                        </div>
                        <button type="submit" class="btn btn-accent w-100">CREAR ZONA</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <h5 class="text-accent small mb-3">LISTADO DE ZONAS REGISTRADAS</h5>
            {% if zonas %}
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th class="text-accent">Nombre</th>
                            <th class="text-accent">Tickets Asociados</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for zona in zonas %}
                        <tr>
                            <td>{{ zona.nombre | upper }}</td>
                            <td>{{ zona.tickets|length }}</td>
                            <td class="text-end">
                                <form method="POST" action="{{ url_for('gestionar_zonas') }}" onsubmit="return confirm('ATENCI√ìN: ¬øEst√° seguro de eliminar la zona {{ zona.nombre | upper }}? Todos los tickets asociados ser√°n desasignados.');" class="d-inline">
                                    <input type="hidden" name="eliminar_zona_id" value="{{ zona.id }}">
                                    <button type="submit" class="btn btn-sm btn-danger">ELIMINAR</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="alert alert-info mt-3">NO HAY ZONAS REGISTRADAS.</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
