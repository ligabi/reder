{% extends "base.html" %}

{% block title %}Panel de Administrador{% endblock %}

{% block content %}
<h1 class="mb-4 text-accent">// PANEL DE ADMINISTRACI√ìN</h1>

<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'tickets' %}active{% endif %}" 
           href="{{ url_for('panel_admin') }}">üìã GESTI√ìN DE INCIDENCIAS</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'usuarios' %}active{% endif %}" 
           href="{{ url_for('gestion_usuarios_admin') }}">üë§ GESTI√ìN DE USUARIOS</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'zonas' %}active{% endif %}" 
           href="{{ url_for('gestion_zonas_admin') }}">üìç GESTI√ìN DE ZONAS</a>
    </li>
</ul>

<div class="tab-content">
    
    {% if active_tab == 'tickets' %}
    <div class="row">
        <div class="col-lg-3">
            <div class="card shadow-sm mb-4 border-accent">
                <div class="card-header bg-charcoal text-accent">
                    RESUMEN DE ESTADOS
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-bg-subtle text-accent">
                        Tickets Abiertos
                        <span class="badge estado-Abierto rounded-pill">{{ status_counts.Abierto }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-bg-subtle text-accent">
                        En Progreso
                        <span class="badge estado-En-Progreso rounded-pill">{{ status_counts['En Progreso'] }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-bg-subtle text-accent">
                        Resueltos
                        <span class="badge estado-Resuelto rounded-pill">{{ status_counts.Resuelto }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-bg-subtle text-accent">
                        Rechazados
                        <span class="badge estado-Rechazado rounded-pill">{{ status_counts.Rechazado }}</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-lg-9">
            <h2 class="mb-3 text-accent">// B√öSQUEDA Y LISTADO DE TICKETS</h2>
            
            <form method="GET" action="{{ url_for('panel_admin') }}" class="row g-2 mb-4 align-items-end">
                <div class="col-md-10">
                    <label for="search_ref" class="form-label small text-accent">BUSCAR POR REF. O T√çTULO</label>
                    <input type="text" class="form-control" id="search_ref" name="search_ref" value="{{ search_ref or '' }}" placeholder="EJ: 0045 o TECHO CON GOTERA">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-accent w-100">BUSCAR</button>
                </div>
            </form>

            {% if tickets %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th class="text-accent">Ref.</th>
                                <th class="text-accent">T√≠tulo</th>
                                <th class="text-accent">Creador</th>
                                <th class="text-accent">Estado</th>
                                <th class="text-accent">Creaci√≥n</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in tickets %}
                            <tr>
                                <td class="text-white fw-bold">#{{ ticket.reference_number }}</td>
                                <td>{{ ticket.titulo | upper }}</td>
                                <td>
                                    <span class="fw-bold">{{ ticket.creador.nombre_completo if ticket.creador else 'N/A' }}</span>
                                    <span class="badge bg-secondary ms-1">{{ ticket.creador.numero_acceso if ticket.creador else '' }}</span>
                                </td>
                                <td>
                                    <span class="badge rounded-pill estado-{{ ticket.estado | default('Abierto') | replace(' ', '-') }} p-2">
                                        {{ ticket.estado | upper }}
                                        {% if ticket.acusado_por_usuario %}<span class="ms-1" title="Cierre Acusado/Archivado">‚úÖ</span>{% endif %}
                                    </span>
                                </td>
                                <td>{{ ticket.fecha_creacion.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    <a href="{{ url_for('ver_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-accent">VER DETALLE</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info mt-3">NO HAY TICKETS REGISTRADOS O NO COINCIDEN CON LA B√öSQUEDA.</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if active_tab == 'usuarios' %}
    <div class="row">
        
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-accent">
                <div class="card-header bg-charcoal text-accent">
                    üë§ CREAR NUEVO USUARIO
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('crear_usuario') }}">
                        <div class="mb-3">
                            <label for="nombre_completo" class="form-label small text-accent">NOMBRE COMPLETO</label>
                            <input type="text" class="form-control" name="nombre_completo" required>
                        </div>
                        <div class="mb-3">
                            <label for="numero_acceso" class="form-label small text-accent">C√ìDIGO DE ACCESO (4 D√çGITOS)</label>
                            <input type="text" class="form-control" name="numero_acceso" maxlength="4" pattern="\d{4}" title="Debe ser 4 d√≠gitos" required>
                        </div>
                        <button type="submit" class="btn btn-accent w-100">REGISTRAR USUARIO</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <h2 class="mb-3 text-accent">// USUARIOS REGISTRADOS</h2>
            {% if usuarios %}
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th class="text-accent">Nombre</th>
                            <th class="text-accent">C√≥digo</th>
                            <th class="text-accent">Tickets Creados</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in usuarios %}
                        <tr>
                            <td>{{ usuario.nombre_completo | upper }}</td>
                            <td class="text-white fw-bold">{{ usuario.numero_acceso }}</td>
                            <td>{{ usuario.tickets|length }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="alert alert-info mt-3">NO HAY USUARIOS REGISTRADOS.</div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% if active_tab == 'zonas' %}
    <div class="row">
        
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-accent">
                <div class="card-header bg-charcoal text-accent">
                    üìç CREAR NUEVA ZONA
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('gestionar_zonas') }}">
                        <div class="mb-3">
                            <label for="nombre_zona" class="form-label small text-accent">NOMBRE DE ZONA</label>
                            <input type="text" class="form-control" name="nombre_zona" required>
                        </div>
                        <button type="submit" class="btn btn-accent w-100">A√ëADIR ZONA</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <h2 class="mb-3 text-accent">// ZONAS REGISTRADAS</h2>
            {% if zonas %}
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th class="text-accent">Nombre</th>
                            <th class="text-accent">Tickets Asociados</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for zona in zonas %}
                        <tr>
                            <td>{{ zona.nombre | upper }}</td>
                            <td>{{ zona.tickets|length }}</td>
                            <td class="text-end">
                                <form method="POST" action="{{ url_for('gestionar_zonas') }}" onsubmit="return confirm('ATENCI√ìN: ¬øEst√° seguro de eliminar la zona {{ zona.nombre | upper }}? Todos los tickets asociados ser√°n desasignados.');" class="d-inline">
                                    <input type="hidden" name="eliminar_zona_id" value="{{ zona.id }}">
                                    <button type="submit" class="btn btn-sm btn-danger">ELIMINAR</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="alert alert-info mt-3">NO HAY ZONAS REGISTRADAS.</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
