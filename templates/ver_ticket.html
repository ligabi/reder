{% extends "base.html" %}

{% block title %}Ticket #{{ ticket.reference_number }}{% endblock %}

{% block content %}
<h1 class="mb-4 text-accent">// DATA STREAM: TICKET #{{ ticket.reference_number }}</h1>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-charcoal text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0 text-accent">{{ ticket.titulo | upper }}</h3>
                <span class="badge fs-6 p-2 estado-{{ ticket.estado | default('Abierto') | replace(' ', '-') }}">
                    {{ ticket.estado | upper }}
                </span>
            </div>
            <div class="card-body">
                
                <h5 class="mb-2 text-accent">üìù DESCRIPCI√ìN</h5>
                <p class="card-text border-start border-3 ps-3 text-muted">
                    {{ ticket.descripcion | replace('\n', '<br>') | safe }}
                </p>
                
                {% if ticket.estado == 'Rechazado' and ticket.motivo_rechazo %}
                <div class="alert alert-danger mt-3">
                    <strong>MOTIVO DE RECHAZO:</strong>
                    <p class="mb-0">{{ ticket.motivo_rechazo | upper }}</p>
                </div>
                {% endif %}

                <hr class="border-accent">

                <div class="row small text-muted">
                    <div class="col-md-6 mb-1">
                        <strong>CREADOR:</strong> {{ creador_nombre | upper }} ({{ creador_acceso }})
                    </div>
                    <div class="col-md-6 mb-1">
                        <strong>ZONA:</strong> 
                        <span class="badge bg-secondary p-1">{{ ticket.zona.nombre | upper if ticket.zona else 'N/A' }}</span>
                    </div>
                    <div class="col-md-6 mb-1">
                        <strong>CREACI√ìN:</strong> {{ ticket.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                    {% if ticket.fecha_actualizacion %}
                    <div class="col-md-6 mb-1">
                        <strong>√öLTIMA ACTUALIZACI√ìN:</strong> {{ ticket.fecha_actualizacion.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                    {% endif %}
                </div>

                {% if ticket.photo_path %}
                <hr class="border-accent">
                <h5 class="mb-2 text-accent">üñºÔ∏è EVIDENCIA FOTOGR√ÅFICA</h5>
                <div class="ticket-photo-container">
                    <img src="{{ url_for('uploaded_file', filename=ticket.photo_path) }}" class="img-fluid rounded border border-accent" alt="Foto del ticket">
                </div>
                {% endif %}

            </div>
        </div>

        <h4 class="mb-3 text-accent">// REGISTRO DE ACTIVIDAD</h4>
        
        {% if puede_comentar %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-bg-subtle border-accent text-accent">
                **A√ëADIR UN COMENTARIO**
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('comentar_ticket', ticket_id=ticket.id) }}">
                    <textarea class="form-control mb-2" name="texto" rows="3" required placeholder="INGRESE SU COMENTARIO/UPDATE AQU√ç..."></textarea>
                    <button type="submit" class="btn btn-accent btn-sm">ENVIAR COMENTARIO</button>
                </form>
            </div>
        </div>
        {% endif %}

        {% if comentarios %}
            {% for comentario in comentarios %}
            <div class="card comment-card mb-3 shadow-sm">
                <div class="card-body p-3">
                    <p class="mb-1 small">
                        <span class="fw-bold text-accent">{{ comentario.nombre_completo | upper }}</span> 
                        <span class="text-muted ms-2">// {{ comentario.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}</span>
                    </p>
                    <p class="mb-0">{{ comentario.texto | replace('\n', '<br>') | safe }}</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">NO HAY REGISTRO DE ACTIVIDAD A√öN.</div>
        {% endif %}
        
        {% if g.rol == 'user' and (ticket.creador_id | string) == g.user_id %}
            {% if ticket.estado in ['Resuelto', 'Rechazado'] and not ticket.acusado_por_usuario %}
            <div class="alert alert-warning mt-4 p-3 d-flex justify-content-between align-items-center">
                <span>// TICKET **{{ ticket.estado | upper }}**. ¬øCONFIRMA EL CIERRE Y ARCHIVADO?</span>
                <form method="POST" action="{{ url_for('acusar_cierre', ticket_id=ticket.id) }}" class="mb-0">
                    <button type="submit" class="btn btn-sm btn-dark"> CONFIRMAR CIERRE </button>
                </form>
            </div>
            {% elif ticket.acusado_por_usuario %}
            <div class="alert alert-success mt-4 p-3"> ‚úÖ ARCHIVADO POR EL USUARIO. </div>
            {% endif %}
        {% endif %}

    </div>
    
    <div class="col-lg-4">
        {% if g.rol == 'admin' %}
        <div class="card shadow-sm mb-4 ticket-details-card">
            <div class="card-header bg-charcoal text-accent border-accent">
                üîß ACCIONES DE ADMINISTRADOR
            </div>
            <div class="card-body">
                
                <h6 class="card-subtitle mb-2 text-accent">ACTUALIZAR ESTADO</h6>
                <form method="POST" action="{{ url_for('cambiar_estado', ticket_id=ticket.id) }}" class="mb-4">
                    <select class="form-select mb-2" name="estado">
                        <option value="Abierto" {% if ticket.estado == 'Abierto' %}selected{% endif %}>ABIERTO</option>
                        <option value="En Progreso" {% if ticket.estado == 'En Progreso' %}selected{% endif %}>EN PROGRESO</option>
                        <option value="Resuelto" {% if ticket.estado == 'Resuelto' %}selected{% endif %}>RESUELTO</option>
                        <option value="Rechazado" {% if ticket.estado == 'Rechazado' %}selected{% endif %}>RECHAZADO</option>
                    </select>
                    
                    <div class="mb-3">
                        <input type="text" class="form-control" name="motivo_rechazo" placeholder="MOTIVO DE RECHAZO (OPCIONAL)">
                    </div>

                    <button type="submit" class="btn btn-primary w-100">EJECUTAR UPDATE</button>
                </form>

                <h5 class="card-title text-accent mt-4">‚úçÔ∏è EDITAR DATOS</h5>
                <form method="POST" action="{{ url_for('editar_ticket_admin', ticket_id=ticket.id) }}">
                    <div class="mb-3">
                        <label for="titulo" class="form-label small text-accent">T√çTULO</label>
                        <input type="text" class="form-control" name="titulo" value="{{ ticket.titulo }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="zona_id" class="form-label small text-accent">ZONA</label>
                        <select class="form-select" name="zona_id">
                            <option value="0">SIN ZONA</option>
                            {% for zona in zonas %}
                                <option value="{{ zona.id }}" {% if ticket.zona_id == zona.id %}selected{% endif %}>
                                    {{ zona.nombre | upper }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <h6 class="card-subtitle mb-2 text-accent small">AJUSTAR DESCRIPCI√ìN</h6>
                    <div class="mb-3">
                        <textarea class="form-control" name="descripcion" rows="3">{{ ticket.descripcion }}</textarea>
                    </div>

                    <h6 class="card-subtitle mb-2 text-accent small">N√öMERO DE REFERENCIA (4 D√çGITOS)</h6>
                    <div class="mb-3">
                        <input type="text" class="form-control" name="reference_number" value="{{ ticket.reference_number or '' }}" maxlength="4" placeholder="EJ: 0001">
                    </div>
                    
                    <button type="submit" class="btn btn-accent w-100">APLICAR CAMBIOS</button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

</div>
<div class="mt-4">
    <a href="{{ url_for('panel_inicio') }}" class="btn btn-outline-secondary">‚Üê VOLVER AL PANEL</a>
</div>
{% endblock %}
